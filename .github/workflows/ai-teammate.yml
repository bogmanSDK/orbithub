name: AI Teammate

on:
  # Trigger manually from GitHub UI
  workflow_dispatch:
    inputs:
      ticket_key:
        description: 'Jira ticket key (e.g., AIH-1)'
        required: true
        type: string
      
  # Trigger via webhook from Jira Automation
  repository_dispatch:
    types: [ai-teammate-trigger]

jobs:
  process-ticket:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      
      - name: ðŸ“š Install dependencies
        run: dart pub get
      
      - name: ðŸ”¨ Generate code
        run: dart run build_runner build --delete-conflicting-outputs
      
      - name: ðŸ”§ Setup environment
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          echo "JIRA_BASE_PATH=$JIRA_BASE_PATH" >> .env
          echo "JIRA_EMAIL=$JIRA_EMAIL" >> .env
          echo "JIRA_API_TOKEN=$JIRA_API_TOKEN" >> .env
          echo "âœ… Environment configured"
      
      - name: ðŸ¤– Run AI Teammate
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          # Get ticket key from either manual trigger or webhook
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TICKET_KEY="${{ inputs.ticket_key }}"
          else
            TICKET_KEY="${{ github.event.client_payload.ticket_key }}"
          fi
          
          echo "ðŸŽ¯ Processing ticket: $TICKET_KEY"
          dart run bin/ai_teammate.dart "$TICKET_KEY"
      
      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "### AI Teammate Workflow Complete ðŸ¤–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ticket**: ${{ inputs.ticket_key || github.event.client_payload.ticket_key }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY



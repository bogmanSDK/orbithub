name: AI Teammate

on:
  # Reusable workflow - called from project repositories
  workflow_call:
    inputs:
      ticket_key:
        description: 'Jira ticket key (e.g., AIH-1)'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: read

jobs:
  process-ticket:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout project repository (where ticket context will be prepared)
      - name: ðŸ“¥ Checkout project code
        uses: actions/checkout@v4
      
      # Step 2: Install OrbitHub CLI (latest version from GitHub Releases)
      - name: ðŸ“¥ Install OrbitHub CLI
        run: |
          curl -fsSL https://github.com/bogmanSDK/orbithub/releases/latest/download/install.sh | bash
          echo "$HOME/.orbithub/bin" >> $GITHUB_PATH
          
          # Export PATH for current shell session
          export PATH="$HOME/.orbithub/bin:$PATH"
          
          # Verify installation
          orbithub --version || (echo "Error: OrbitHub installation failed" && exit 1)
      
      - name: ðŸ”§ Setup environment
        working-directory: orbithub
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          # Validate required secrets
          if [ -z "$JIRA_BASE_PATH" ]; then
            echo "âŒ Error: JIRA_BASE_PATH secret is not set"
            exit 1
          fi
          if [ -z "$JIRA_EMAIL" ]; then
            echo "âŒ Error: JIRA_EMAIL secret is not set"
            exit 1
          fi
          if [ -z "$JIRA_API_TOKEN" ]; then
            echo "âŒ Error: JIRA_API_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$AI_API_KEY" ]; then
            echo "âš ï¸  Warning: AI_API_KEY secret is not set"
            echo "âš ï¸  AI features will be disabled"
          fi
          
          # Create .env file in project root (not orbithub/)
          cd "$GITHUB_WORKSPACE"
          echo "JIRA_BASE_PATH=$JIRA_BASE_PATH" >> .env
          echo "JIRA_EMAIL=$JIRA_EMAIL" >> .env
          echo "JIRA_API_TOKEN=$JIRA_API_TOKEN" >> .env
          echo "AI_PROVIDER=${AI_PROVIDER:-openai}" >> .env
          echo "AI_API_KEY=$AI_API_KEY" >> .env
          echo "âœ… Environment configured"
      
      - name: ðŸ¤– Run AI Teammate
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          DISABLE_JIRA_COMMENTS: 'true'
        run: |
          TICKET_KEY="${{ inputs.ticket_key }}"
          
          if [ -z "$TICKET_KEY" ]; then
            echo "âŒ Error: Ticket key is empty"
            exit 1
          fi
          
          echo "ðŸŽ¯ Processing ticket: $TICKET_KEY"
          # Run from project root using OrbitHub CLI
          cd "$GITHUB_WORKSPACE"
          orbithub ai-teammate --ticket-key "$TICKET_KEY"
      
      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "### AI Teammate Workflow Complete ðŸ¤–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          TICKET_KEY="${{ inputs.ticket_key }}"
          echo "**Ticket**: $TICKET_KEY" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

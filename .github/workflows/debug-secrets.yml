name: Debug Secrets

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: üìä Check Secrets Availability
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          echo "=== Secret Availability Check ==="
          echo ""
          
          if [ -z "$JIRA_BASE_PATH" ]; then
            echo "‚ùå JIRA_BASE_PATH: NOT SET"
          else
            echo "‚úÖ JIRA_BASE_PATH: SET (${#JIRA_BASE_PATH} chars)"
            echo "   First 30 chars: ${JIRA_BASE_PATH:0:30}..."
          fi
          
          if [ -z "$JIRA_EMAIL" ]; then
            echo "‚ùå JIRA_EMAIL: NOT SET"
          else
            echo "‚úÖ JIRA_EMAIL: SET (${#JIRA_EMAIL} chars)"
            echo "   Value: ${JIRA_EMAIL:0:5}***@***"
          fi
          
          if [ -z "$JIRA_API_TOKEN" ]; then
            echo "‚ùå JIRA_API_TOKEN: NOT SET"
          else
            echo "‚úÖ JIRA_API_TOKEN: SET (${#JIRA_API_TOKEN} chars)"
            echo "   First 20 chars: ${JIRA_API_TOKEN:0:20}..."
          fi
          
          if [ -z "$AI_PROVIDER" ]; then
            echo "‚ö†Ô∏è  AI_PROVIDER: NOT SET (optional)"
          else
            echo "‚úÖ AI_PROVIDER: SET"
            echo "   Value: $AI_PROVIDER"
          fi
          
          if [ -z "$AI_API_KEY" ]; then
            echo "‚ö†Ô∏è  AI_API_KEY: NOT SET (optional)"
          else
            echo "‚úÖ AI_API_KEY: SET (${#AI_API_KEY} chars)"
            echo "   First 15 chars: ${AI_API_KEY:0:15}..."
          fi
          
          echo ""
          echo "=== Summary ==="
          REQUIRED_COUNT=0
          if [ ! -z "$JIRA_BASE_PATH" ]; then ((REQUIRED_COUNT++)); fi
          if [ ! -z "$JIRA_EMAIL" ]; then ((REQUIRED_COUNT++)); fi
          if [ ! -z "$JIRA_API_TOKEN" ]; then ((REQUIRED_COUNT++)); fi
          
          echo "Required secrets set: $REQUIRED_COUNT/3"
          
          if [ $REQUIRED_COUNT -eq 3 ]; then
            echo "‚úÖ All required secrets are configured!"
          else
            echo "‚ùå Missing required secrets!"
            exit 1
          fi
      
      - name: üß™ Test Jira Connection
        if: success()
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          echo ""
          echo "=== Testing Jira API Connection ==="
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            "$JIRA_BASE_PATH/rest/api/3/myself")
          
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ SUCCESS! Jira authentication works!"
            
            # Get user info
            USER_INFO=$(curl -s -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
              "$JIRA_BASE_PATH/rest/api/3/myself")
            
            echo ""
            echo "Authenticated as:"
            echo "$USER_INFO" | grep -o '"displayName":"[^"]*"' | cut -d'"' -f4
            echo "$USER_INFO" | grep -o '"emailAddress":"[^"]*"' | cut -d'"' -f4
            
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "‚ùå FAILED: Invalid credentials (401 Unauthorized)"
            echo ""
            echo "Possible issues:"
            echo "1. JIRA_EMAIL is incorrect"
            echo "2. JIRA_API_TOKEN is invalid or expired"
            echo "3. Token was created for different Atlassian account"
            exit 1
            
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "‚ùå FAILED: Jira site not found (404)"
            echo ""
            echo "Possible issues:"
            echo "1. JIRA_BASE_PATH is incorrect"
            echo "2. Check URL format: https://your-domain.atlassian.net"
            exit 1
            
          else
            echo "‚ùå FAILED: Unexpected response ($HTTP_CODE)"
            exit 1
          fi
      
      - name: üéØ Test Ticket Access
        if: success()
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          echo ""
          echo "=== Testing Ticket Access ==="
          
          # Try to get AIH-11
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            "$JIRA_BASE_PATH/rest/api/3/issue/AIH-11")
          
          echo "Trying to get AIH-11: HTTP $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Can access AIH-11"
            
            # Get ticket info
            TICKET_INFO=$(curl -s -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
              "$JIRA_BASE_PATH/rest/api/3/issue/AIH-11?fields=summary,status")
            
            echo "Summary:" $(echo "$TICKET_INFO" | grep -o '"summary":"[^"]*"' | cut -d'"' -f4)
            
          else
            echo "‚ùå Cannot access AIH-11 (HTTP $HTTP_CODE)"
          fi
          
          # List recent tickets
          echo ""
          echo "Recent tickets in AIH project:"
          curl -s -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            "$JIRA_BASE_PATH/rest/api/3/search?jql=project=AIH&maxResults=5&fields=key,summary" | \
            grep -o '"key":"[^"]*"' | cut -d'"' -f4 | head -5
      
      - name: ‚úÖ Diagnosis Complete
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ ALL CHECKS PASSED!"
          echo "=========================================="
          echo ""
          echo "Your secrets are configured correctly."
          echo "If AI Teammate workflow still fails, the issue is in the Dart code."

